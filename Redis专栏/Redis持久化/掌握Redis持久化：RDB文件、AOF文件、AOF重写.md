## 1. Redis持久化

### 1.1 持久化概念

> ***面试官：知道Redis持久化吗？***

Redis本身是一个基于内存的数据库，它提供了RDB持久化、AOF持久化两种方式，用来将存储在内存中的数据库状态保存到磁盘中。前者是保存了整个Redis**数据库状态**，而后者是保存了从Redis启动后所有执行的写命令。接下来我们就从这两方面展开。

### 1.2 生成RDB文件

> ***面试官：你说一说生成RDB文件的命令是什么？***

触发RDB持久化过程分为手动触发和自动触发，手动触发的命令有两个，一个是`SAVE`命令，一个是`BGSAVE`命令，执行命令后会在根目录生成名为`dump.rdb`的文件。

大家看下以下手动触发的使用。

```shell
# 手动生成RDB文件指令
127.0.0.1:6379> save
OK
127.0.0.1:6379> bgsave
Background saving started
```

另外RDB文件是在Redis启动时**自动载入**，如果把`dump.rdb`文件删除，重启Redis后会发现原先的数据库状态都不存在了。

```shell
# 初始化
127.0.0.1:6379> set name JavaGetOffer
OK
127.0.0.1:6379> get name
"JavaGetOffer"
127.0.0.1:6379> save
OK

# 重启Redis
127.0.0.1:6379> get name
"JavaGetOffer"

# 删除dump.rdb，重启Redis后name为nil
127.0.0.1:6379> get name
(nil)
```

### 1.3 两种命令的选择

> ***面试官：你会在什么场景使用什么命令？***

SAVE命令会**阻塞**Redis服务器进程，直到RDB文件创建完毕为止，在服务器进程阻塞期间，服务器不能处理其他任何命令请求。

而BGSAVE命令则**不进行阻塞**，它会派生出一个子进程，然后由**子进程**负责创建RDB文件，服务器进程继续处理命令请求。可以在上面的指令中看到执行BGSAVE指令后，终端显示`Background saving started`。

所以如果在**业务高峰期**要使用进行RDB持久化，建议是使用后者，可以防止某些请求丢失了。

### 1.4 生成AOF文件

> ***面试官：AOF文件生成呢？***

AOF文件生成需要在Redis配置文件配置`appendonly`的属性值。

```shell
appendonly yes
```

重启Redis执行写命令后，会生成`appendonly.aof`文件。

也可以在终端手动设置`appendonly`属性值。

```shell
config set appendonly yes
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/274cc76129a0490ab46f0a662a1b0b1e.png#pic_center)

## 2. AOF重写

### 2.1 AOF概念

> ***面试官：知道AOF文件重写吗？***

AOF文件是AOF持久化的产物，AOF持久化通过保存服务器所有执行的写命令来记录数据库状态。而AOF文件重写主要是为了解决**AOF文件体积膨胀**的问题。

对于一个键值对，AOF旧的文件会保存数十条对该键值对的修改命令，这样浪费了大量内存空间。

而AOF文件重写可以创建一个新的AOF文件来**替代**现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，但新AOF文件**不会包含任何浪费空间**的冗余命令，使得新的AOF文件体积很小。

简单来说，就是新的AOF文件只会保存键值对的**最终状态的创建命令**。

### 2.2 多条命令记录键值

> ***面试官：照你这么说，只会保存创建命令，那每个键的创建只有一条命令对吧？***

如果每个键的创建只有一条命令，在执行命令时可能会造成**客户端输入缓冲区**溢出。

Redis重写程序在处理列表、哈希表、集合、有序集合这四种可能会带有多个元素的键时，如果元素的数量超过了`redis.h/REDIS_AOF_REWRITE_ITEMS_PER_CMD`常量的值，那么重写程序将使用**多条命令**来记录键的值，而不单单只使用一条命令。

### 2.3 AOF重写缓冲区

> ***面试官：AOF重写过程中，有新的创建请求进来怎么办？***

AOF重写过程中，有新的创建请求进来怎么办？可以把这些新的创建请求写入到一个缓冲区里。

Redis服务器会维护一个**AOF重写缓冲区**，该缓冲区会在**子进程**创建新AOF文件期间，记录服务器执行的所有写命令。

等新的AOF文件创建完成，Redis服务器会将重写缓冲区中的所有内容**追加**到新AOF文件的末尾，从而保证两个新旧AOF文件状态一致。

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/eaf7036c67d7465f8600465e164da251.png#pic_center)